/*******************************************************************
*	Session:	Side Channel Attacks in SQL Server
*	Author:		Ben Johnston
*	Name:		Demo03.DirectAttack.03.DBCC.PAGE.sql
*	Notes:		Shows how admin functions can be used to bypass both
*				masking and RLS. Requires elevated access
*				Not available in Azure SQL Database
********************************************************************/
USE WWISideChannel
GO

--Baseline query - no rows returned
SELECT *
FROM Purchasing.PurchaseOrders
GO

IF (SELECT COUNT(*) FROM sys.indexes WHERE name = 'IX_PurchasingPurchaseOrders_Covering') > 0
BEGIN
DROP INDEX Purchasing.PurchaseOrders.IX_PurchasingPurchaseOrders_Covering
END

CREATE NONCLUSTERED INDEX IX_PurchasingPurchaseOrders_Covering
ON Purchasing.PurchaseOrders (
	PurchaseOrderID
	,SupplierID
	,OrderDate
	,DeliveryMethodID
	,ContactPersonID
	,ExpectedDeliveryDate
	,SupplierReference
	,IsOrderFinalized
	--,Comments                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         InternalComments                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 LastEditedBy LastEditedWhen
)
INCLUDE (
	Comments
)


SELECT 
	SS.name			SchemaName
	,SO.name		ObjectName
	,SI.name		IndexName
	,SI.index_id
	,SI.type_desc
	,DB_ID()		DatabaseID
FROM sys.schemas SS
	INNER JOIN sys.objects SO
		ON SS.schema_id	= SO.schema_id
	INNER JOIN sys.indexes SI
		ON SO.object_id	= SI.object_id
WHERE
	SS.name				= 'Purchasing'
	AND SO.name			= 'PurchaseOrders'

--ALTER INDEX ALL ON Purchasing.PurchaseOrders REBUILD WITH(SORT_IN_TEMPDB = ON);


--Show allocated pages for the Purchasing.PurchaseOrders table
--@DatabaseId SMALLINT,
--@TableId INT = NULL,
--@IndexId INT = NULL,
--@PartitionId BIGINT = NULL,
--@Mode NVARCHAR(64) = 'LIMITED' --'DETAILED'
SELECT *
FROM SYS.DM_DB_DATABASE_PAGE_ALLOCATIONS(db_id(),object_id('Purchasing.PurchaseOrders'),1,NULL,'detailed')
GO
  
--Show raw page data. Based on page numbers shown in above scripts. 1414 is the last page in this physical database
--Traceflag is needed to have the output go to the screen
DBCC TRACEON(3604)
GO
--File ID: 3
--Page ID: 1888
--Output type: 3 --Header and per-row output
DBCC PAGE('WWISideChannel',3,132264,3)
GO


DBCC PAGE('WWISideChannel',3,132264,2)
GO

--The following is available in Azure, but it doesn't show page details at the same level
SELECT *
FROM sys.dm_db_page_info(db_id(),3,32904,'DETAILED')
GO
